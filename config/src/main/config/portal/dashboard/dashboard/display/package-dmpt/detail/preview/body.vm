##parseTemplate("form-components/access-control.vm")
<script>
function manage_access(e) {
	$("#dialog-form").dialog("open");
}
</script>

<div>
    #set($oid = $metadata.get("id"))
    <h1>$metadata.get('project.name') data management plan</h1>
    <p>
    <span>Project ID</span>
    <span>$metadata.get('project.id')</span>
    </p>
    <h4>Description:</h4>
    <p>$metadata.get('project.description')</p>
    <div style="text-align:center">
    <a href="$portalPath/download/$oid/Data%20Management%20Plan.pdf">Download a PDF of this plan
    <img alt="Get PDF" src="$portalPath/images/icons/mimetype/application/pdf/icon.png" height="20" width="20" >
    </a>
    </div>
    <table>
    <tr><td>Info of sub flow 1</td><td>Done</td></tr>
    <tr><td>Info of sub flow 2</td><td>Not filled</td></tr>
    </table>
    <p>You can add information to your plan to assist us in working with you to manage your research data.</p>
</div>
#macro(sectionHeading $heading)
<span class="accordion-header">$heading</span>
#end

<div id="toggle-accordion" class="toggle-accordion">
    <span id="toggle-accordion-icon" class="ui-icon ui-icon-triangle-1-e"></span>
    <span id="toggle-accordion-text">Show all sections</span>
</div>
<div class="accordion">
	#sectionHeading("Plan details")
	<div class="meta"></div>
	#sectionHeading("Overview")
	<div class="meta"></div>
	#sectionHeading("People")
	<div class="meta"></div>
	#sectionHeading("Data collection")
	<div class="meta"></div>
	#sectionHeading("Data structure")
	<div class="meta"></div>
	#sectionHeading("Ethics and sensitivities")
	<div class="meta"></div>
</div>

<script type="text/javascript">
$(function(){
    function addAccordion() {
        $(".accordion").accordion({
            autoHeight:false,
            clearStyle:true,
            collapsible:false,
            header:".accordion-header"
        });
    }
    $("#toggle-accordion").click(function(){
        if ($(".ui-accordion").length > 0) {
            $(".accordion").fadeOut(function(){
                $(this).accordion("destroy");
                $(".accordion-header").each(function() {
                    $(this).addClass("accordion-reset");
                });
                $(this).fadeIn();
            });
            $("#toggle-accordion-text").text("Show sections individually");
        } else {
            $(".accordion").fadeOut(function(){
                addAccordion();
                $(".accordion-header").each(function() {
                    $(this).removeClass("accordion-reset");
                });
                $(this).fadeIn();
            });
            $("#toggle-accordion-text").text("Show all sections");
        }
        $("#toggle-accordion-icon").toggleClass("ui-icon-triangle-1-e ui-icon-triangle-1-s");
        return false;
    });
    addAccordion();
});
</script>
<div class="article">
<h1 style="margin-top:1.5em">Data Sets</h1>
<p style="margin-bottom: 0px;">The following datasets have been linked to this plan.<br>
You can also add more:<a id='create-selfsubmission' href='#'><img src="$portalPath/images/icons/package_add.png" alt="Create a dataset based on this plan"/></a></p>
#parseTemplate("home/dmpt/mydatasets.vm")
</div>
<div class="clear"></div>

<script type="text/javascript">
    
	$(document).ready(function() {
		$('#create-selfsubmission').click(function () {
			var processing = false;
        	if (processing) return;
        	processing = true;
        	jQuery("#create-selfsubmission").append('<img class="right" src="http://localhost:9000/redbox/verNum1.6-SNAPSHOT/default/images/icons/loading.gif" />');
        	jQuery.ajax({
            	type: "POST",
            	url: "$portalPath/actions/packaging.ajax",
            	data: {
                	ajax: 1,
                	func: "create-new",
                	packageType: "simple",
                	metaList: ["title", "dc:description", "redbox:newForm", "redbox:formVersion"],
                	title: "[Untitled]",
                	description: "",
                	"redbox:newForm": "true",
                	"redbox:formVersion": "1.6-SNAPSHOT"
            	}, success: function(data) {
                if (data.status == "ok") {
                    function copyMetadata() {
                    	var oid = "$metadata.get('storage_id')";
                    	jQuery.ajax({
            	type: "POST",
            	url: "$portalPath/copyTfPackage.ajax",
            	data: {
                	ajax: 1,
                	fromOid: oid,
                	toOid: data.oid,
                	tfMetaPropertyValue: "dmptToSimple"
            		}, success: function(data) {
            		 	                if (data.status == "ok") {
                    function redirect() {
                        window.location.href = data.url;
                    }
                    setTimeout(redirect, 1500);
                } else {
                    alert("Failed to copy record!");
                }
            		 	

            		},error:  function(xhr, status, e) {
                		alert("Failed to create record!"); 
           		 },
            	dataType: "json"
        		});
                    	
                    	
                
                    }
                    setTimeout(copyMetadata, 1500);
                } else {
                    alert("Failed to create record!");
                }
            },
            error: function(xhr, status, e) {
                alert("Failed to create record!");
            },
            dataType: "json"
        });
        	return false;
		});
	
	
	});
</script>