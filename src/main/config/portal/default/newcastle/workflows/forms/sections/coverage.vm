<h3><a href="#coverage">Coverage</a></h3>
<div id="coverage" class="inputscreen">
    #fieldTitle("dc:coverage" "Date Coverage" false)
    <div class="help-content" id="help-dc:coverage">
        Use this to indicate a date range relevant to the research
        dataset/collection, registry/repository, catalogue or index. Year format
        requires manual entry, eg. 1990 to 2010
    </div>
    <p>
        <input type="text" placeholder="eg. 1990" class="dateYMD" id="dc:coverage.from" />
        <label for="dc:coverage.to">to</label>
        <input type="text" placeholder="eg. 2010" class="dateYMD" id="dc:coverage.to" />
        <label class="validation-err-msg" for="dc:coverage.from"
            data-validation-rule="when(blur,change,submit);name(testCoverageFrom);
                    test(/^[12]\d{3}([-\/]+(10|11|12|0?\d)([-\/]+(30|31|[012]?\d))?)?$/ or empty);">
            A valid from date or year is required!
        </label>
        <label class="validation-err-msg" for="dc:coverage.to"
            data-validation-rule="when(blur,change,submit);name(testCoverageTo);
                    test(/^[12]\d{3}([-\/]+(10|11|12|0?\d)([-\/]+(30|31|[012]?\d))?)?$/ or empty);">
            A valid to date or year is required!
        </label>
    </p>

    #fieldTitle("time_period" "Time Period" false)
    <div class="help-content" id="help-time_period">
        A text description of a time period relating to the coverage of the
        research dataset/collection, registry/repository, catalogue or index, if
        applicable, eg. 21st Century, WWII, The Depression, etc.
    </div>
    <p>
        <input type="text" id="time_period" size="60"
            placeholder="eg. 21st Century, WWII, The Depression, etc." />
    </p>

    #fieldTitle("location" "Geospatial Location" false)
    <div class="help-content" id="help-location">
        Geospatial location relevant to the research dataset/collection,
        registry/repository, catalogue or index. This may describe a
        geographical area where data was collected, a place which is the subject
        of a collection, or a location which is the focus of an activity, eg.
        coordinates or placename.
    </div>
    <table class="input-list">
        <thead>
            <tr>
                <th></th>
                <th>Type</th>
                <th>Value</th>
                <th colspan="3"></th>
            </tr>
        </thead>
        <tbody>
            <tr class="item-input-display">
                <td class="sort-number"></td>
                <td>
                    <select class="locationType" id="location.0.type">
                        <option selected>Please select one...</option>
                        <option value="gml">OpenGIS Geography Markup Language</option>
                        <option value="gmlKmlPolyCoords">KML long/lat co-ordinates derived from GML</option>
                        <option value="gpx">GPS Exchange Format</option>
                        <option value="iso31661">Country code (iso31661)</option>
                        <option value="iso31662">Country subdivision code (iso31662)</option>
                        <option value="iso19139dcmiBox">DCMI Box notation (iso19139)</option>
                        <option value="kml">Keyhole Markup Language</option>
                        <option value="kmlPolyCoords">KML long/lat co-ordinates</option>
                        <option value="dcmiPoint">DCMI Point notation</option>
                        <option value="text">Free text</option>
                    </select>
                </td>
                <td>
                    <input type="text" size="60" placeholder="eg. coordinates or placename"
                        id="location.0.dcmi:name" class="autocomplete-geonames" />
                    <input type="hidden" id="location.0.geonames:uri" />
                    <input type="hidden" id="location.0.dcmi:east" />
                    <input type="hidden" id="location.0.dcmi:north" />
                    <div class="hidden coords" id="location.0.coords">
                        <a class="map-link" target="_blank" href="">map</a>
                        @ longitude: <span class="east"> </span>
                        , latitude: <span class="north"> </span>
                        | <a class="clear-link" href="#">clear</a>
                    </div>
                </td>
                <td class="delete-item"><a href="#">delete</a></td>
                <td style="width: 100%;" />
            </tr>
        </tbody>
        <tfoot>
            <tr>
                <td></td>
                <td><input type="button" class="button add-another-item" id="add-location" value="Add location" /></td>
                <td colspan="3"></td>
            </tr>
        </tfoot>
    </table>
</div>
<script type="text/javascript">
$(function(){
    function splitGeonamesData(row) {
        var items = row[0].split("::");
        return {
            id: items[0],
            uri: items[1],
            display: items[2],
            north: items[3],
            east: items[4]
        };
    }

    $("#add-location").click(function(){
        $("#location\\.0\\.coords").hide();
    });

    $(".autocomplete-geonames").live("focus", function(){
        var elem = $(this);
        var baseId = elem.attr("id").replace(".dcmi:name", "");
        elem.unautocomplete();
        if($("select[id='"+baseId+".type']").val()=="text"){
            elem.autocomplete(
                "$portalPath/proxyGet?ns=Geonames&autocomplete=true&fields=id,geonames_uri,display,latitude,longitude",
                {
                    extraParams: {
                        qs: function() {
                            var userInput = elem.val();
                            var commaPos = userInput.indexOf(",");
                            if(commaPos!=-1){
                                userInput = userInput.substring(0,commaPos);
                            }
                            return "func=search&format=json&rows=25&q=" + escape(userInput);
                        }
                    },
                    formatItem: function(row) { return splitGeonamesData(row).display; },
                    formatResult: function(row) { return splitGeonamesData(row).display; },
                    width: "40em"
                }).result(function(event, row) {
                    if (row) {
                        var data = splitGeonamesData(row);
                        var coordsElem = $("div[id='"+baseId+".coords']");
                        $("input[id='"+baseId+".geonames:uri']").val(data.uri);
                        $("input[id='"+baseId+".dcmi:east']").val(data.east);
                        $("input[id='"+baseId+".dcmi:north']").val(data.north);
                        coordsElem.find(".east").text(data.east);
                        coordsElem.find(".north").text(data.north);
                        coordsElem.find(".map-link").attr("href", data.uri);
                        coordsElem.show();
                    }
                })
            }
        }).live("blur", function(){
            $(this).search();
        });

    $(".clear-link").live("click", function(){
        var p = $(this).parent();
        var baseId = p.attr("id").replace(".coords", "");
        $("input[id='"+baseId+".geonames:uri']").removeAttr("value");
        $("input[id='"+baseId+".dcmi:east']").removeAttr("value");
        $("input[id='"+baseId+".dcmi:north']").removeAttr("value");
        p.hide();
    });

    $(".locationType").live("change", function(e){
        var elem=$(this);
        var baseId = elem.attr("id").replace(".type", "");
        var uriElem=$("input[id='"+baseId+".geonames:uri']");
        if(elem.val()!="text" && uriElem.val()!=""){
            if(confirm("Are you sure you want to clear the Geonames linked location?")){
                $("input[id='"+baseId+".dcmi:name']").val("");
                $("div[id='"+baseId+".coords'] .clear-link").click();
            }else{
                $(this).val("text");
            }
        }
    });
});
</script>
