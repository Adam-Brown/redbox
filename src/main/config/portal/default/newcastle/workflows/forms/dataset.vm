#macro(fieldTitle $id $label $required)
    <h2>
        <label for="$id">$label#if($required)<span class="required">(*)</span>#end</label>
        <span class="helpWidget" data-help-content-id="help-$id">
            <img src="$portalPath/images/icons/help.png"/>
        </span>
    </h2>
#end

#macro(requiredValidation $id $message)
    <label class="validation-err-msg" for="$id"
        data-validation-rule="when(blur,change,submit);test(notEmpty)">
        $message
    </label>
#end

#macro(dateValidation $id)
    <label class="validation-err-msg" for="dc:created"
        data-validation-rule="when(blur,change,submit);test(yyyy_mm_dd or empty);">
        A valid date created must be entered (yyyy-mm-dd else leave blank)!
    </label>
#end

#macro(mintSelectField $id $labelId $sourceUrl $idKey $labelKey $listKey $defaultValue)
    <span class="data-source-drop-down"
          data-json-source-url="$sourceUrl"
          data-id-key="$idKey"
          data-label-key="$labelKey"
          data-list-key="$listKey"
          #if("$!defaultValue"!="")data-default-value="$!defaultValue"#end>
        <span class="selection-added">
            <input type="hidden" class="selection-added-id" id="$id" name="$id" />
            <input type="text" class="selection-added-label" readonly="readonly" id="$labelId" name="$labelId" />
            <a href="#" class="clear-item">change</a>
        </span>
        <span class="drop-down-location">
            <button class="selection-add add-unique-only" data-add-on-click="1">
                Select
            </button>
        </span>
    </span>
#end

#macro(mintMultiSelectField $id $labelId $sourceUrl $idKey $labelKey $listKey $childrenKey)
    <table class="input-list">
        <tfoot>
            <tr class="item-input">
                <td>
                    <span class="data-source-drop-down"
                          data-json-source-url="$sourceUrl"
                          data-top-level-id="top"
                          data-id-key="$idKey"
                          data-label-key="$labelKey"
                          data-list-key="$listKey"
                          data-children-key="$childrenKey">
                        <input type="text" class="selection-added-label" id="$labelId" />
                        <input type="text" class="selection-added-id" id="$id" />
                    </span>
                    <button class="item-add selection-add add-unique-only reset-on-add">
                        Select
                    </button>
                </td>
            </tr>
        </tfoot>
        <tbody>
            <tr class="item-display">
                <td>
                    <span class="item-display-item"></span>
                    <span class="item-display-item hidden"></span>
                    <a class="delete-item" href="#">delete</a>
                </td>
            </tr>
        </tbody>
    </table>
#end

#macro(inputList $id $placeholder $addLabel $requiredLabel)
    #set($vid = $self.getCleanId($id))
    <table class="input-list">
        <tbody>
            <tr class="item-input-display sortable-item">
                <td class="sort-number"></td>
                <td>
                    <input type="text" size="60" placeholder="$placeholder" id="${id}.0" class="v${vid}" />
                </td>
                <td class="delete-item"><a href="#">delete</a></td>
                <td style="width: 100%;">
                    #if("$!requiredLabel" != "")
                    <label for="${id}.0" class="validation-err-msg"
                        data-validation-rule="test(notEmpty);when(blur,change,submit);liveFor(.v${vid});">
                        $requiredLabel
                    </label>
                    #end
                </td>
            </tr>
        </tbody>
        <tfoot>
            <tr>
                <td></td>
                <td><input type="button" class="button add-another-item" value="$addLabel" /></td>
                <td colspan="2"></td>
            </tr>
        </tfoot>
    </table>
#end

#set($noLayout = true)
#set($oid = $self.getFormData("oid"))
#set($portalPath = $self.getFormData("portalPath"))
#set($stage = $self.getFormData("stage"))
#set($stageLabel = $self.getFormData("stageLabel"))
#set($nextStageMessage = $self.getFormData("nextStageMessage"))

<div class="widget-form" id="main-form"
    data-pre-save-func="preSave"
    data-save-result-func="saveSuccess"
    data-save-url="$portalPath/actions/workflow.ajax?func=update-package-meta&oid=$oid"
    data-submit-result-func="submitSuccess"
    data-submit-url="$portalPath/actions/workflow.ajax?func=update-package-meta-deposit&oid=$oid">
    <input type="hidden" class="form-fields" value="
        ## general
        dc:title,
        dc:type,
        dc:type.skos:prefLabel,
        dc:coverage.from,
        dc:coverage.to,
        dc:created,
        dc:modified,
        time_period,
        location.0.type,
        location.0.dcmi:name,
        location.0.dcmi:east,
        location.0.dcmi:north,
        location.0.geonames:uri,
        dc:language,
        dc:language.skos:prefLabel,
        ## description
        dc:description,
        citations.0,
        citations.0.notes,
        data.0,
        data.0.notes,
        website.0,
        website.0.notes,
        ## people
        dc:creator.foaf:Person.0.dc:identifier,
        dc:creator.foaf:Person.0.dc:title,
        dc:creator.foaf:Person.0.ci,
        dc:creator.foaf:Person.0.pi,
        dc:creator.foaf:Person.0.foaf:givenName,
        dc:creator.foaf:Person.0.foaf:familyName,
        dc:creator.foaf:Person.0.association,
        dc:creator.foaf:Person.0.association.skos:prefLabel,
        primaryContact.dc:identifier,
        primaryContact.dc:title,
        primaryContact.foaf:givenName
        primaryContact.foaf:familyName
        primaryContact.foaf:email,
        supervisor.0.dc:identifier,
        supervisor.0.dc:title,
        supervisor.0.foaf:givenName,
        supervisor.0.foaf:familyName,
        collaborators.0,
        ## subject
        dc:subject.anzsrc:seo.0.skos:prefLabel,
        dc:subject.anzsrc:seo.0.rdf:resource,
        dc:subject.anzsrc:for.0.skos:prefLabel,
        dc:subject.anzsrc:for.0.rdf:resource,
        dc:subject.keywords.0,
        research_activity,
        research_activity.skos:prefLabel,
        ## provenance
        sources_used,
        access_conditions,
        embargo_release,
        embargo_expiry,
        restrictions,
        license_cc,
        license_cc.skos:prefLabel,
        license_other_name,
        license_other_url,
        ## management
        url,
        url.useRecordId,
        physical_storage,
        location_notes,
        retention_period,
        disposal_date,
        data_owner,
        data_custodian,
        affiliation.0,
        affiliation.0.skos:prefLabel,
        grant.0.uon:internal,
        grant.0.grantNumber,
        grant.0.dc:identifier,
        grant.0.skos:prefLabel,
        funding.0.skos:prefLabel,
        funding.0.rdf:resource,
        project_title,
        depositor,
        data_size,
        extent,
        policy,
        contracts,
        management_plan,
        management_plan_notes,
        ## notes
        notes.0.date,
        notes.0.username,
        notes.0.description,
        ## submission request
        submitted,
        submitDate,
        submitDescription,
        contactName,
        phoneNumber,
        emailAddress
    " />
    <input type="hidden" class="form-fields-readonly" value="xmlns:dc, xmlns:foaf, xmlns:anzsrc, metaList" />
    <input type="hidden" id="metaList" value="[]" />
    <input type="hidden" id="xmlns:dc" value="http://dublincore.org/documents/2008/01/14/dcmi-terms/" />
    <input type="hidden" id="xmlns:foaf" value="http://xmlns.com/foaf/spec/" />
    <input type="hidden" id="xmlns:anzsrc" value="http://purl.org/anzsrc/" />
    <input type="hidden" id="submitted" value="$self.getFormData('submitted')"/>
    <div class="clear"></div>
    <div id="form-heading">
        <a id="view-record-link" class="right" href="$portalPath/detail/$oid">View record</a>
        <span><img src="${portalPath}/images/icons/wf_${stage}.png" />$stageLabel</span>
    </div>
    <div class="inputscreens">
        #parseTemplate("workflows/forms/sections/general.vm")
        #parseTemplate("workflows/forms/sections/coverage.vm")
        #parseTemplate("workflows/forms/sections/description.vm")
        #parseTemplate("workflows/forms/sections/people.vm")
        #parseTemplate("workflows/forms/sections/subject.vm")
        #parseTemplate("workflows/forms/sections/rights.vm")
        #parseTemplate("workflows/forms/sections/management.vm")
        #parseTemplate("workflows/forms/sections/attach.vm")
        #parseTemplate("workflows/forms/sections/notes.vm")
        #parseTemplate("workflows/forms/sections/request.vm")
        #parseTemplate("workflows/forms/sections/submit.vm")
    </div>
    <div class="navigation">
        <span class="go-prev-tab">
            <img src="../images/icons/arrow_left.png" height="30" alt="Go to the previous section of the form" />
        </span>
        <span class="go-next-tab">
            <img src="../images/icons/arrow_right.png" height="30" alt="Go to the next section of the form" />
        </span>
        <input type="button" class="button form-fields-save" value="Save" />
        <input type="button" class="button form-fields-save-close" value="Save and close" />
        <span class="saved-result"></span>
    </div>
</div>
<script type="text/javascript">
var saveAndClose = false;
$(function(){
    $("#view-record-link").click(function(){
        if(widgets.forms[0].hasChanges()){
            return confirm("The record has been modified.\nAre you sure you want to leave this page?");
        }
    });

    $(".go-prev-tab").click(function(){
        var selected = widgetTabs.tabs("option", "selected");
        var last = widgetTabs.tabs("length");
        if(selected==0){
            widgetTabs.tabs("select", last-1);
        }else{
            widgetTabs.tabs("select", selected-1);
        }
    });

    $(".go-next-tab").click(function(){
        var selected = widgetTabs.tabs("option", "selected");
        var last = widgetTabs.tabs("length");
        if(selected==last-1){
            widgetTabs.tabs("select", 0);
        }else{
            widgetTabs.tabs("select", selected+1);
        }
    });

    $(".form-fields-save-close").click(function(){
        saveAndClose = true;
        $(".form-fields-save").click();
    });

    $(".form-fields-save").click(function(){
        var t, id, title, v=widgets.forms[0].validator;
        try{
            if(v.isOkToSave()==false){
                t=jQ("textarea[id=dc:title]");
                title = jQ.trim(t.val());
                if(title=="" || title=="[Untitled]"){
                    widgets.messageBox("A 'Title' is required!",
                        function(){
                            id=t.parents(".ui-tabs-panel").attr("id");
                            jQ("a[href=#"+id+"]").click();
                            t.focus();
                        });
                    t.focus();
                }else{
                    widgets.messageBox("Cannot save! Please check and fill in required fields!");
                }
            }
        }catch(e){
            alert("Error in save-click - "+e.message);
        }
    });
});

function preSave(widgetForm, data){
    $(".saved-result").html('<img src="$portalPath/images/icons/loading.gif" />').show();
}

function saveSuccess(){
    if(saveAndClose){
        window.location.href = "$portalPath/home";
    }
}

function submitSuccess(){
    window.location.href = "$portalPath/detail/$oid";
}
</script>
