#macro(heading $required)
#end
#set($noLayout = true)
#parseTemplate("workflows/forms/sections/navigation.vm")
<div class="widget-form" id="main-form"
     data-submit-result-func="submitted_ok"
     data-pre-save-func="preSave"
     data-save-func="aboutToSave"
     data-save-url="{packageData.portalPath}/workflow.ajax?func=update-package-meta&amp;oid={packageData.oid}"
     data-submit-url="{packageData.portalPath}/workflow.ajax?func=update-package-meta-deposit&amp;oid={packageData.oid}">
    <input type="hidden" class="form-fields" value="
        ## general
        dc:title,
        dc:coverage.from,
        dc:coverage.to,
        dc:created,
        dc:modified,
        time_period,
        dc:language,
        dc:language.skos:prefLabel,
        location,
        dc:type,
        ## description
        dc:description,
        citations.0,
        data,
        website,
        ## people
        dc:creator.foaf:Person.0.dc:identifier,
        dc:creator.foaf:Person.0.pi,
        dc:creator.foaf:Person.0.coPi,
        dc:creator.foaf:Person.0.foaf:givenName,
        dc:creator.foaf:Person.0.foaf:familyName,
        dc:creator.foaf:Person.0.association,
        dc:creator.foaf:Person.0.association.skos:prefLabel,
        primary_contact_name,
        primary_contact_email,
        supervisor,
        collaborators.0,
        ## subject
        dc:subject.anzsrc:seo.0.skos:prefLabel,
        dc:subject.anzsrc:seo.0.rdf:resource,
        dc:subject.anzsrc:for.0.skos:prefLabel,
        dc:subject.anzsrc:for.0.rdf:resource,
        dc:subject.keywords.0,
        research_activity,
        ## provenance
        sources_used,
        access_conditions,
        embargo_release,
        embargo_expiry,
        restrictions,
        license_cc,
        license_other,
        ## management
        url,
        physical_storage,
        retention_period,
        disposal_date,
        data_owner,
        data_custodian,
        affiliation.0,
        affiliation.0.skos:prefLabel,
        grant.0.uon:internal,
        grant.0.rdf:resource,
        grant.0.dc:identifier,
        grant.0.skos:prefLabel,
        funding.0.skos:prefLabel,
        funding.0.rdf:resource,
        project_title,
        depositor,
        data_size,
        extent,
        policy,
        contracts,
        management_plan,
        ## submission request
        submitted,
        submitDate,
        description,
        contactName,
        phoneNumber,
        emailAddress
    " />
    <input type="hidden" class="form-fields-readonly" value="xmlns:dc, xmlns:foaf, xmlns:anzsrc, metaList" />
    <input type="hidden" id="metaList" value="[]" />
    <input type="hidden" id="xmlns:dc" value="http://dublincore.org/documents/2008/01/14/dcmi-terms/" />
    <input type="hidden" id="xmlns:foaf" value="http://xmlns.com/foaf/spec/" />
    <input type="hidden" id="xmlns:anzsrc" value="http://purl.org/anzsrc/" />
    <div class="clear"></div>
    <h1 style="padding-bottom:1em;">
        <a id="view-record-link" style="float:right;padding-right:4px;font-size:0.6em;" href="$portalPath/detail/">View record</a>
        <span id="title"> </span>
    </h1>
    <div class="inputscreens changeToTabLayout">
        <h3><a href="#screen1">General</a></h3>
        <div id="screen1" class="inputscreen">
            #parseTemplate("workflows/forms/sections/general.vm")
            #nav(false true)
        </div>
        <h3><a href="#screen2">Description</a></h3>
        <div id="screen2" class="inputscreen">
            #parseTemplate("workflows/forms/sections/description.vm")
            #nav(true true)
        </div>
        <h3><a href="#screen3">People</a></h3>
        <div id="screen3" class="inputscreen">
            #parseTemplate("workflows/forms/sections/people.vm")
            #nav(true true)
        </div>
        <h3><a href="#screen4">Subject</a></h3>
        <div id="screen4" class="inputscreen">
            #parseTemplate("workflows/forms/sections/subject.vm")
            #nav(true true)
        </div>
        <h3><a href="#screen5">Rights</a></h3>
        <div id="screen5" class="inputscreen">
            #parseTemplate("workflows/forms/sections/provenance.vm")
            #nav(true true)
        </div>
        <h3><a href="#screen6">Management</a></h3>
        <div id="screen6" class="inputscreen">
            #parseTemplate("workflows/forms/sections/management.vm")
            #nav(true true)
        </div>
        <h3><a href="#screen7">Attachments</a></h3>
        <div id="screen7" class="inputscreen">
            #parseTemplate("workflows/forms/sections/attach.vm")
            #nav(true true)
        </div>
        <h3 class="request"><a href="#screen8">Request</a></h3>
        <div id="screen8" class="inputscreen request">
            #parseTemplate("workflows/forms/sections/request.vm")
            #nav(true true)
        </div>
        <h3><a href="#screen9">Submit</a></h3>
        <div id="screen9" class="inputscreen">
            #parseTemplate("workflows/forms/sections/submit.vm")
            #nav(true false)
        </div>
    </div>
##    <span class="saved-result"></span>
</div>
<script type="text/javascript">
var jQ=$;
jQ(function(){
    jQ("#title").html('<span><img src="' + packageData.portalPath +
        "/images/icons/wf_" + packageData.stage + '.png" /> ' +
        packageData.stageLabel + "</span>");
    $("#view-record-link").click(function(){
        var href = jQ(this).attr("href");
        $(this).attr("href", href+packageData.oid);
        if(widgets.forms[0].hasChanges()){
            return confirm("Are you sure you want to leave this page without saving first!");
        }
    });
    jQ(".tab-nav .next-tab,.tab-nav .prev-tab").click(function(){
        if(widgets.forms[0].hasChanges()){
            jQ(".form-fields-save:first").click();
        }
    });
    jQ(".form-fields-save").click(function(){
        var t, id, title, v=widgets.forms[0].validator;
        try{
            if(v.isOkToSave()==false){
                t=jQ("textarea[id=dc:title]");
                title = jQ.trim(t.val());
                if(title=="" || title=="[Untitled]"){
                    widgets.messageBox("A 'Title' is required!",
                        function(){
                            id=t.parents(".ui-tabs-panel").attr("id");
                            jQ("a[href=#"+id+"]").click();
                            t.focus();
                        });
                    t.focus();
                }else{
                    widgets.messageBox("Cannot save! Please check and fill in required fields!");
                }
            }
        }catch(e){
            alert("Error in save-click - "+e.message);
        }
    });
    // HACK - a work around for a BUG in Chrome - where the help stops working on the
    //      'General' tab page after navigating away and back again!
    setTimeout(function(){
      jQ("a[href=#screen1]").click(function(){
        setTimeout(function(){jQ("#screen1").hide().show();}, 10);
      });
    }, 100);
});

function preSave(a,b){
    $(".saved-result").html("<img src='../images/loading-progress.gif'/>").show();
}

function aboutToSave(w,data){
}

</script>
